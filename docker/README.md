# Environnement Docker pour ReverseEngineeringBundle

Ce r√©pertoire contient la configuration Docker pour tester le bundle avec la base de donn√©es Sakila.

## üê≥ Services Docker

### MySQL 8.0 avec Sakila
- **Image** : `mysql:8.0`
- **Port** : `3306`
- **Base de donn√©es** : `sakila`
- **Utilisateur** : `sakila_user`
- **Mot de passe** : `sakila_password`

### PHP 8.2 CLI
- **Image** : PHP 8.2 avec extensions n√©cessaires
- **Extensions** : PDO, PDO_MySQL, MySQLi, Zip, GD, MBString, XML, BCMath
- **Composer** : Inclus

### phpMyAdmin (optionnel)
- **Port** : `8080`
- **URL** : http://localhost:8080

## üöÄ D√©marrage rapide

### 1. D√©marrer l'environnement

```bash
# Depuis la racine du projet
docker-compose up -d

# Ou utiliser le script utilitaire
./docker-test.sh start
```

### 2. V√©rifier que MySQL est pr√™t

```bash
# Attendre que le conteneur soit healthy
docker-compose ps

# V√©rifier les logs MySQL
docker-compose logs mysql

# Ou utiliser le script utilitaire
./docker-test.sh status
```

### 3. G√©n√©rer et r√©cup√©rer les entit√©s Sakila

```bash
# G√©n√©ration et copie automatique (recommand√©)
./docker-test.sh generate-and-copy

# Les entit√©s seront disponibles dans ./generated-entities/
```

### 4. Ex√©cuter les tests avec Sakila

```bash
# Tests d'int√©gration Sakila uniquement
docker-compose exec php vendor/bin/phpunit tests/Integration/SakilaIntegrationTest.php

# Ou utiliser le script utilitaire
./docker-test.sh test-sakila

# Tous les tests
./docker-test.sh test-all
```

## üìä Base de donn√©es Sakila

La base de donn√©es Sakila est une base de donn√©es d'exemple MySQL qui simule un magasin de location de DVD. Elle contient :

### Tables principales
- **`actor`** : Acteurs des films
- **`film`** : Catalogue des films
- **`customer`** : Clients du magasin
- **`rental`** : Locations de films
- **`payment`** : Paiements
- **`inventory`** : Inventaire des films
- **`store`** : Magasins
- **`staff`** : Personnel
- **`address`** : Adresses
- **`city`** : Villes
- **`country`** : Pays
- **`category`** : Cat√©gories de films
- **`language`** : Langues

### Relations complexes
- **Many-to-One** : `customer` ‚Üí `address`, `film` ‚Üí `language`
- **One-to-Many** : `customer` ‚Üí `rental`, `film` ‚Üí `inventory`
- **Many-to-Many** : `film` ‚Üî `actor` (via `film_actor`), `film` ‚Üî `category` (via `film_category`)

### Types de donn√©es vari√©s
- **Entiers** : `TINYINT`, `SMALLINT`, `MEDIUMINT`, `INT`
- **D√©cimaux** : `DECIMAL(4,2)`, `DECIMAL(5,2)`
- **Texte** : `VARCHAR`, `CHAR`, `TEXT`
- **Dates** : `DATE`, `DATETIME`, `TIMESTAMP`, `YEAR`
- **√ânum√©rations** : `ENUM('G','PG','PG-13','R','NC-17')`
- **Sets** : `SET('Trailers','Commentaries',...)`
- **Bool√©ens** : `BOOLEAN`
- **Binaire** : `BLOB`

## üß™ Tests disponibles

### Tests d'int√©gration Sakila
```bash
# Test complet de g√©n√©ration d'entit√©s
docker-compose exec php vendor/bin/phpunit tests/Integration/SakilaIntegrationTest.php::testCompleteEntityGeneration

# Test des relations complexes
docker-compose exec php vendor/bin/phpunit tests/Integration/SakilaIntegrationTest.php::testComplexRelations

# Test des types de donn√©es
docker-compose exec php vendor/bin/phpunit tests/Integration/SakilaIntegrationTest.php::testDataTypeMapping

# Test de performance
docker-compose exec php vendor/bin/phpunit tests/Integration/SakilaIntegrationTest.php::testPerformanceOnFullDatabase
```

### G√©n√©ration manuelle d'entit√©s

#### G√©n√©ration dans le conteneur uniquement
```bash
# G√©n√©rer toutes les entit√©s Sakila dans le conteneur
docker-compose exec php php scripts/generate-entities.php \
    --namespace="Sakila\\Entity" \
    --output-dir="generated/sakila"

# Ou utiliser le script utilitaire
./docker-test.sh generate
```

#### G√©n√©ration et copie automatique vers l'h√¥te local
```bash
# G√©n√©ration et copie automatique (recommand√©)
./docker-test.sh generate-and-copy

# Avec r√©pertoire de destination personnalis√©
./docker-test.sh generate-and-copy ./my-entities

# Avec r√©pertoire et namespace personnalis√©s
./docker-test.sh generate-and-copy ./src/Entity "MyApp\\Entity"
```

#### Avantages de la commande `generate-and-copy`
- ‚úÖ G√©n√©ration automatique dans le conteneur Docker
- ‚úÖ Copie automatique des fichiers vers l'h√¥te local
- ‚úÖ Validation de la syntaxe PHP des fichiers copi√©s
- ‚úÖ Nettoyage automatique des fichiers temporaires
- ‚úÖ Statistiques d√©taill√©es (temps, taille, nombre de fichiers)
- ‚úÖ Correction automatique des permissions
- ‚úÖ R√©sum√© complet des op√©rations

## üîÑ Commande `generate-and-copy` - Guide complet

### Description
La commande `generate-and-copy` automatise compl√®tement le processus de g√©n√©ration d'entit√©s depuis la base de donn√©es Sakila et leur r√©cup√©ration sur l'h√¥te local. Cette commande combine la g√©n√©ration dans le conteneur Docker avec la copie automatique des fichiers g√©n√©r√©s.

### Syntaxe
```bash
./docker-test.sh generate-and-copy [r√©pertoire_destination] [namespace]
```

### Param√®tres
- **`r√©pertoire_destination`** (optionnel) : R√©pertoire local o√π copier les entit√©s g√©n√©r√©es
  - D√©faut : `./generated-entities`
  - Exemple : `./src/Entity`, `./my-entities`

- **`namespace`** (optionnel) : Namespace PHP pour les entit√©s g√©n√©r√©es
  - D√©faut : `Sakila\\Entity`
  - Exemple : `MyApp\\Entity`, `App\\Entity\\Sakila`

### Exemples d'utilisation

#### Utilisation basique
```bash
# G√©n√©ration avec param√®tres par d√©faut
./docker-test.sh generate-and-copy

# R√©sultat : Entit√©s dans ./generated-entities/ avec namespace Sakila\Entity
```

#### R√©pertoire personnalis√©
```bash
# Sp√©cifier un r√©pertoire de destination
./docker-test.sh generate-and-copy ./my-entities

# R√©sultat : Entit√©s dans ./my-entities/ avec namespace Sakila\Entity
```

#### R√©pertoire et namespace personnalis√©s
```bash
# Sp√©cifier r√©pertoire et namespace
./docker-test.sh generate-and-copy ./src/Entity "MyApp\\Entity"

# R√©sultat : Entit√©s dans ./src/Entity/ avec namespace MyApp\Entity
```

### Processus d√©taill√©

1. **V√©rification de l'environnement**
   - Contr√¥le que Docker et Docker Compose sont install√©s
   - V√©rification que l'environnement MySQL est d√©marr√©

2. **Pr√©paration**
   - Cr√©ation du r√©pertoire de destination local
   - Nettoyage du r√©pertoire de g√©n√©ration dans le conteneur

3. **G√©n√©ration des entit√©s**
   - Ex√©cution du script de g√©n√©ration dans le conteneur PHP
   - Mesure du temps d'ex√©cution
   - Validation de la g√©n√©ration

4. **Copie des fichiers**
   - Utilisation de `docker cp` pour copier les fichiers
   - Pr√©servation de la structure des r√©pertoires
   - Correction automatique des permissions

5. **Validation et nettoyage**
   - Validation de la syntaxe PHP (si PHP disponible sur l'h√¥te)
   - Nettoyage des fichiers temporaires dans le conteneur
   - G√©n√©ration du rapport final

### Structure des fichiers g√©n√©r√©s

```
generated-entities/          # R√©pertoire de destination
‚îú‚îÄ‚îÄ Actor.php               # Entit√© Actor
‚îú‚îÄ‚îÄ ActorRepository.php     # Repository Actor
‚îú‚îÄ‚îÄ Film.php                # Entit√© Film
‚îú‚îÄ‚îÄ FilmRepository.php      # Repository Film
‚îú‚îÄ‚îÄ Customer.php            # Entit√© Customer
‚îú‚îÄ‚îÄ CustomerRepository.php  # Repository Customer
‚îî‚îÄ‚îÄ ...                     # Autres entit√©s et repositories
```

### Informations affich√©es

La commande affiche un rapport d√©taill√© incluant :

- **Temps de g√©n√©ration** : Dur√©e de la g√©n√©ration des entit√©s
- **Nombre de fichiers** : Entit√©s et repositories g√©n√©r√©s
- **Taille totale** : Espace disque utilis√© par les fichiers
- **Validation syntaxe** : R√©sultat de la validation PHP
- **Liste des fichiers** : D√©tail de chaque fichier g√©n√©r√© avec sa taille

### Exemple de sortie

```bash
$ ./docker-test.sh generate-and-copy ./my-entities "MyApp\\Entity"

[INFO] G√©n√©ration et copie automatique des entit√©s...
[INFO] R√©pertoire de destination local: ./my-entities
[INFO] Namespace: MyApp\Entity
[INFO] R√©pertoire local cr√©√©: ./my-entities
[INFO] Nettoyage du r√©pertoire de g√©n√©ration dans le conteneur...
[INFO] G√©n√©ration des entit√©s dans le conteneur Docker...
[SUCCESS] Entit√©s g√©n√©r√©es avec succ√®s en 12s
[INFO] R√©cup√©ration de la liste des fichiers g√©n√©r√©s...
[INFO] Fichiers √† copier: 32
[INFO] Copie des fichiers du conteneur vers l'h√¥te local...
[SUCCESS] Fichiers copi√©s avec succ√®s vers ./my-entities
[INFO] Correction des permissions des fichiers...
[INFO] Validation de la syntaxe PHP des fichiers copi√©s...
[INFO] Nettoyage des fichiers temporaires dans le conteneur...

[SUCCESS] üéâ G√©n√©ration et copie termin√©es avec succ√®s !

[INFO] üìä R√©sum√© des op√©rations:
[INFO]    - Temps de g√©n√©ration: 12s
[INFO]    - Fichiers g√©n√©r√©s: 32
[INFO]    - Fichiers copi√©s: 32
[INFO]    - Taille totale: 156K
[INFO]    - R√©pertoire de destination: ./my-entities
[INFO]    - Namespace utilis√©: MyApp\Entity
[SUCCESS]    - Validation syntaxe: ‚úÖ Tous les fichiers sont valides

[INFO] üìÅ Fichiers g√©n√©r√©s:
[INFO]    - Actor.php (2.1K)
[INFO]    - ActorRepository.php (1.2K)
[INFO]    - Film.php (4.8K)
[INFO]    - FilmRepository.php (1.2K)
[INFO]    - ...

[INFO] üí° Pour utiliser ces entit√©s dans votre projet Symfony:
[INFO]    1. Copiez les fichiers vers src/Entity/ de votre projet
[INFO]    2. Ajustez le namespace selon votre configuration
[INFO]    3. Ex√©cutez 'php bin/console doctrine:schema:validate'

[SUCCESS] Op√©ration termin√©e avec succ√®s !
```

### Int√©gration dans un projet Symfony

Apr√®s g√©n√©ration, pour utiliser les entit√©s dans votre projet :

1. **Copier les fichiers**
   ```bash
   cp ./generated-entities/*.php /path/to/your/symfony/project/src/Entity/
   ```

2. **Ajuster le namespace** (si n√©cessaire)
   ```php
   // Remplacer dans tous les fichiers
   namespace Sakila\Entity;
   // Par
   namespace App\Entity;
   ```

3. **Valider avec Doctrine**
   ```bash
   cd /path/to/your/symfony/project
   php bin/console doctrine:schema:validate
   ```

4. **G√©n√©rer les migrations** (si n√©cessaire)
   ```bash
   php bin/console doctrine:migrations:diff
   ```

## üîß Configuration

### Variables d'environnement
Les variables suivantes peuvent √™tre modifi√©es dans [`docker-compose.yml`](../docker-compose.yml) :

```yaml
environment:
  MYSQL_ROOT_PASSWORD: root_password
  MYSQL_DATABASE: sakila
  MYSQL_USER: sakila_user
  MYSQL_PASSWORD: sakila_password
```

### Configuration MySQL
La configuration MySQL est dans [`mysql/conf/my.cnf`](mysql/conf/my.cnf) :
- Charset UTF8MB4
- InnoDB optimis√©
- Query cache activ√©
- Logs des requ√™tes lentes

### Configuration PHP
La configuration PHP est dans [`php/conf/php.ini`](php/conf/php.ini) :
- M√©moire : 512M
- Temps d'ex√©cution : 300s
- Extensions MySQL activ√©es
- OPcache optimis√©

## üêõ D√©pannage

### MySQL ne d√©marre pas
```bash
# V√©rifier les logs
docker-compose logs mysql

# Red√©marrer le service
docker-compose restart mysql

# Reconstruire l'image
docker-compose build --no-cache mysql
```

### Connexion refus√©e
```bash
# V√©rifier que le port 3306 est libre
netstat -tlnp | grep 3306

# Attendre que MySQL soit pr√™t
docker-compose exec mysql mysqladmin ping -h localhost -u root -p
```

### Base de donn√©es vide
```bash
# V√©rifier l'initialisation
docker-compose logs mysql | grep -i sakila

# R√©initialiser les donn√©es
docker-compose down -v
docker-compose up -d
```

### Tests √©chouent
```bash
# V√©rifier la connexion depuis PHP
docker-compose exec php php -r "
try {
    \$pdo = new PDO('mysql:host=mysql;dbname=sakila', 'sakila_user', 'sakila_password');
    echo 'Connexion OK\n';
    \$stmt = \$pdo->query('SELECT COUNT(*) FROM actor');
    echo 'Acteurs: ' . \$stmt->fetchColumn() . '\n';
} catch (Exception \$e) {
    echo 'Erreur: ' . \$e->getMessage() . '\n';
}
"
```

## üìà Performance

### M√©triques attendues
- **Temps de g√©n√©ration** : < 30 secondes pour toutes les tables
- **M√©moire utilis√©e** : < 128 MB
- **Tables trait√©es** : 15+ tables principales
- **Entit√©s g√©n√©r√©es** : 15+ entit√©s avec relations

### Optimisations
- Index sur les cl√©s √©trang√®res
- Query cache MySQL activ√©
- OPcache PHP configur√©
- Connexions persistantes

## üîí S√©curit√©

### Acc√®s r√©seau
- MySQL accessible uniquement depuis localhost:3306
- phpMyAdmin accessible depuis localhost:8080
- Pas d'exposition externe par d√©faut

### Authentification
- Utilisateur MySQL d√©di√© (non-root)
- Mots de passe configurables
- Base de donn√©es isol√©e

## üìù Maintenance

### Sauvegarde
```bash
# Exporter la base Sakila
docker-compose exec mysql mysqldump -u sakila_user -p sakila > sakila_backup.sql
```

### Nettoyage
```bash
# Arr√™ter et supprimer les conteneurs
docker-compose down

# Supprimer les volumes (donn√©es perdues)
docker-compose down -v

# Supprimer les images
docker-compose down --rmi all
```

### Mise √† jour
```bash
# Mettre √† jour les images
docker-compose pull

# Reconstruire les services
docker-compose build --no-cache

# Red√©marrer
docker-compose up -d